<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Test</title>
</head>
<body>
    <h1>SignalR Azure Test</h1>

    <form id="connectForm">
        <label for="bearer">Bearer</label>
        <input type="text" id="bearer" required />
        <button type="submit" id="connect">Connect</button>
    </form>

    <br />
    <div id="notification" style="max-height:300px; overflow:auto;">
        <h2>Notification</h2>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        let connection = null;

        function addNotification(message, addTime = true, senderName = null) {
            const notificationDiv = document.getElementById("notification");
            const p = document.createElement("p");

            if (addTime) {
                const timeSpan = document.createElement("span");
                timeSpan.textContent = `[${new Date().toLocaleTimeString()}] `;
                p.appendChild(timeSpan);
            }

            const nameSpan = document.createElement("span");
            nameSpan.textContent = senderName?.trim() || "System";
            p.appendChild(nameSpan);

            p.appendChild(document.createTextNode(": "));
            const messageSpan = document.createElement("span");
            messageSpan.textContent = message;
            p.appendChild(messageSpan);

            notificationDiv.appendChild(p);
            notificationDiv.scrollTop = notificationDiv.scrollHeight; // Auto-scroll
        }

        document.getElementById("connectForm").onsubmit = async (e) => {
            e.preventDefault();
            const connectBtn = document.getElementById("connect");
            connectBtn.disabled = true;

            const bearer = document.getElementById("bearer").value.trim();
            if (!bearer) {
                addNotification("Bearer token required", true);
                alert("Bearer token required");
                connectBtn.disabled = false;
                return;
            }

            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/hubs/chat", { accessTokenFactory: () => bearer })
                    .withAutomaticReconnect()
                    .build();

                connection.on("ReceiveMessage", (sender, message) => {
                    addNotification(message, true, sender);
                });

                connection.onclose(error => {
                    if (error) {
                        addNotification("Disconnected due to error.", true, "System");
                        console.error(error);
                    } else {
                        addNotification("Disconnected.", true, "System");
                    }
                });

                connection.onreconnecting(error => {
                    addNotification("Reconnecting...", true, "System");
                });

                connection.onreconnected(connectionId => {
                    addNotification("Reconnected successfully.", true, "System");
                });

                await connection.start();
                addNotification("Successfully connected to SignalR hub.", true, "System");

            } catch (err) {
                addNotification(`Connection failed: ${err?.message ?? "Unknown error"}`, true, "System");
                console.error("SignalR connection error:", err);
            } finally {
                connectBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
