<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat</title>
</head>
<body>
    <h1>SignalR Chat Room</h1>

    <!-- LOGIN -->
    <div id="loginSection">
        <form id="loginForm">
            <label for="name">Name</label>
            <input type="text" id="name" required min="1" />
            <button type="submit" id="connect">Connect</button>
        </form>
    </div>

    <!-- TOKENS -->
    <div id="tokenSection" style="display:none;">
        <h3>Tokens</h3>
        <div>
            <strong>Login Token:</strong>
            <pre id="loginToken"></pre>
        </div>
        <div>
            <strong>Chat Token:</strong>
            <pre id="chatToken"></pre>
        </div>
    </div>

    <!-- CHAT -->
    <div id="chatSection" style="display:none;">
        <hr />
        <form id="chatForm">
            <input type="text" id="messageInput" placeholder="Type a message..." required />
            <button type="submit" id="send">Send</button>
            <button type="button" id="logout">Logout</button>
        </form>
    </div>

    <hr />
    <div id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        let connection = null;

        function addNotification(message, addTime = true, senderName = null) {
            const div = document.getElementById("notification");
            const p = document.createElement("p");

            if (addTime) {
                p.appendChild(document.createTextNode(`[${new Date().toLocaleTimeString()}] `));
            }

            p.appendChild(document.createTextNode(senderName?.trim() || "System"));
            p.appendChild(document.createTextNode(": " + message));

            div.appendChild(p);
            div.scrollTop = div.scrollHeight; // Auto-scroll to bottom
        }

        async function postJson(url, headers = {}) {
            const response = await fetch(url, { method: "POST", headers });
            if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
            return response.json();
        }

        // LOGIN FORM
        document.getElementById("loginForm").onsubmit = async (e) => {
            e.preventDefault();
            const connectBtn = document.getElementById("connect");
            connectBtn.disabled = true;

            const name = document.getElementById("name").value.trim();
            if (!name) {
                alert("Name is required.");
                connectBtn.disabled = false;
                return;
            }

            try {
                const login = await postJson(`/auth/login?name=${encodeURIComponent(name)}`);
                document.getElementById("loginToken").textContent = login.accessToken;

                const chat = await postJson("/auth/chat-token", { "Authorization": `Bearer ${login.accessToken}` });
                document.getElementById("chatToken").textContent = chat.accessToken;

                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/hubs/chat", { accessTokenFactory: () => chat.accessToken })
                    .withAutomaticReconnect()
                    .build();

                connection.on("ReceiveMessage", (sender, message) => {
                    addNotification(message, true, sender);
                });

                connection.onclose(() => addNotification("Disconnected.", true, "System"));

                await connection.start();
                addNotification("Connected.", true, "System");

                // UI transitions
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("tokenSection").style.display = "block";
                document.getElementById("chatSection").style.display = "block";
            } catch (err) {
                console.error("SignalR connection error:", err);
                addNotification(`Connection failed: ${err?.message ?? "Unknown error"}`, true, "System");
            } finally {
                connectBtn.disabled = false;
            }
        };

        // CHAT FORM
        document.getElementById("chatForm").onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById("messageInput");
            const message = input.value.trim();
            const sendBtn = document.getElementById("send");

            if (!message || !connection) return;

            sendBtn.disabled = true;

            try {
                await connection.invoke("SendMessage", message);
                input.value = "";
                input.focus();
            } catch (err) {
                console.error(err);
                addNotification("Failed to send message.", true, "System");
            } finally {
                sendBtn.disabled = false;
            }
        };

        document.getElementById("logout").onclick = async () => {
            if (connection) {
                await connection.stop().catch(() => {});
                connection = null;
            }

            document.getElementById("loginSection").style.display = "block";
            document.getElementById("tokenSection").style.display = "none";
            document.getElementById("chatSection").style.display = "none";

            document.getElementById("loginToken").textContent = "";
            document.getElementById("chatToken").textContent = "";
            document.getElementById("notification").innerHTML = "";

            addNotification("Logged out.", true, "System");
        };
    </script>
</body>
</html>
